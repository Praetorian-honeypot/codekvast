<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Codekvast by crispab</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Codekvast</h1>
          <h2>Codekvast, the Truly Dead Code Detector</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/crispab/codekvast/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/crispab/codekvast/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/crispab/codekvast" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a id="codekvast---the-truly-dead-code-detector" class="anchor" href="#codekvast---the-truly-dead-code-detector" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Codekvast - the Truly Dead Code Detector</h1>

<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h2>

<p>Codekvast detects <strong>Truly Dead Code</strong> in <strong>Java-applications</strong>.</p>

<p>By <em>Truly Dead Code</em> we mean code that is in production, but <em>has not been used by anyone for a certain period of time</em>.</p>

<p>Codekvast works by attaching the <strong>Codekvast Collector</strong> to your application.
The collector records the instant when methods belonging to any of your packages are invoked. </p>

<p>By default Codekvast tracks <em>public</em> and <em>protected</em> methods. Modern IDEs like IntelliJ IDEA can detect dead code which have <em>package 
private</em> or <em>private</em> visibility. They can never know what callers there are to public and protected methods though.</p>

<p>This is where Codekvast can help. Codekvast <em>records when your methods are invoked in production</em>.</p>

<p>The collector periodically sends the recorded data to the <strong>Codekvast Daemon</strong>, which combines the invocation data
with an inventory of <em>all</em> methods in your application. (It's the methods that <em>not</em> have been invoked recently that
constitutes Truly Dead Code, remember?)</p>

<p>The Codekvast Daemon is installed in the same host as your application, since it needs access to your application's binaries
 (jar files) to make the inventory.</p>

<p>The Codekvast Daemon periodically produces a zip file containing both the method inventory and the collected invocation data.</p>

<p>The zip files from all daemons should be transferred to a central <strong>Codekvast Warehouse</strong>, which aggregates the data, and makes
it available to users in a web interface.</p>

<p>The Codekvast Daemon can be configured to automatically upload the zip files to the warehouse by means of SCP. If SCP is not an option,
the zip files must be transferred manually somehow.</p>

<p>By using the Codekvast Warehouse, you can find out whether a certain method, class or package is safe to remove or not.</p>

<p><em>Codekvast collects the data. You then combine that with your domain knowledge to make informed decisions about what is truly dead code
that safely could be deleted.</em></p>

<h3>
<a id="performance" class="anchor" href="#performance" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Performance</h3>

<p>Codekvast Collector is extremely efficient. It adds approximately <em>15 ns</em> to each method invocation. If this is unacceptable,
you can exclude certain time critical packages from collection.</p>

<p>The collected data volumes are quite moderate. When tested on a telecom equipment vendors' fairly large network management application,
the local database maintained by Codekvast Daemon occupies less than 200 MB disk space.</p>

<p>The zip file for that case weighs less than 3 MB. </p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>License</h2>

<p>Codekvast is released under the MIT license.</p>

<h2>
<a id="development-status" class="anchor" href="#development-status" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Development Status</h2>

<ul>
<li>
<p>The Codekvast Collector is fairly complete and stable.</p>

<p>Tentative road-map:</p>

<ol>
<li>Mechanism for delivering collected data to the daemon over a TCP socket instead of text files in the local file system. This will
make it possible to use Codekvast in e.g., Heroku and Google App Engine. </li>
</ol>
</li>
<li>
<p>The Codekvast Daemon is fairly stable.</p>

<p>Tentative Road-map:</p>

<ol>
<li>Add a mechanism for pruning the local database once data has been delivered to the warehouse.</li>
<li>Add a mechanism for receiving collected data from the collectors using TCP sockets.</li>
<li>Add other mechanisms than scp for delivering data to the central warehouse.</li>
<li>Add devops stuff. (ping, health checks, JMX, metrics, ...)</li>
</ol>
</li>
<li>
<p>The Codekvast Warehouse is <strong>very</strong> rudimentary. It aggregates and persists data alright, but the user interface is absent. (For the moment
the only functionality offered is a view in the database schema).</p>

<p>Tentative road-map:</p>

<ol>
<li>Add a web UI.</li>
<li>Add a IDE plugin API.</li>
<li>Add a mechanism for informing daemons that they safely can prune data.</li>
<li>Add more mechanisms for receiving data from daemons (currently supported: zip files, optionally pushed by scp).<br>
</li>
</ol>
</li>
</ul>

<p><em>NOTE:</em> the collector and the daemon communicates via the local file system. This means that Codekvast for the moment is unusable in e.g., Heroku and
Google App Engine.</p>

<h2>
<a id="how-to-kick-the-tyres" class="anchor" href="#how-to-kick-the-tyres" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How To Kick The Tyres</h2>

<p>The following procedure will download and start two different versions of Jenkins and launch them in Tomcat 7, with Codekvast Collector attached.
It will also build and start Codekvast Daemon and Codekvast Warehouse.</p>

<ol>
<li><p>Install <strong>JDK 8</strong> (OpenJDK or Oracle are fine.) </p></li>
<li><p>Install <a href="https://docs.docker.com/engine/installation/">Docker Engine</a> and <a href="https://docs.docker.com/compose/install/">Docker Compose</a></p></li>
<li><p>Open a terminal window</p></li>
<li><p>Do <code>git clone https://github.com/crispab/codekvast.git &amp;&amp; cd codekvast</code></p></li>
<li><p>Open 4 more terminal windows or tabs with <code>codekvast</code> as working directory.</p></li>
<li>
<p>In terminal window #1 do <code>./gradlew :sample:jenkins1:run</code></p>

<p>This will download and start Jenkins inside Tomcat with Codekvast Collector attached.</p>

<p>You can access Jenkins #1 at http://localhost:8081/jenkins</p>

<p><em>NOTE:</em> The download of jenkins.war could take some time. Be patient!</p>
</li>
<li>
<p>In terminal window #2 do <code>./gradlew :sample:jenkins2:run</code></p>

<p>Downloads and starts another version of Jenkins inside another Tomcat also with Codekvast Collector attached.</p>

<p>You can access Jenkins #2 at http://localhost:8082/jenkins</p>
</li>
<li>
<p>In terminal window #3 do <code>./gradlew :product:warehouse:distDocker</code></p>

<p>This will build a local Docker image for Codekvast Warehouse from the sources.</p>
</li>
<li>
<p>In terminal window #3 do <code>docker-compose -f product/warehouse/docker-compose.yml up</code></p>

<p>This will launch two Docker containers: <strong>codekvast-database</strong> (MariaDB) and <strong>codekvast-warehouse</strong> (the Codekvast Warehouse app).</p>

<p>The warehouse app is configured to look for zip files in /tmp/codekvast/.warehouse and import them into the MariaDB database.</p>
</li>
<li><p>In terminal window #4 do <code>sudo chmod o+rw /tmp/codekvast/.warehouse</code> or else the Codekvast Daemon cannot create it's zip files there.</p></li>
<li>
<p>In terminal window #4 do <code>./gradlew :product:agent:daemon:run</code></p>

<p>This will launch <strong>Codekvast daemon</strong>, that will process output from the collectors attached to the two Jenkins instances.</p>

<p>The daemon will regularly produce zip data files in /tmp/codekvast/.warehouse (where Codekvast Warehouse will find and consume them).</p>
</li>
<li>
<p>In terminal window #5 do <code>docker exec -ti codekvast-database mysql -ucodekvast -pcodekvast codekvast_warehouse</code></p>

<p>Examine the collected data by means of <code>SELECT * FROM MethodInvocations1;</code></p>

<p>Examine the view with <code>DESCRIBE MethodInvocations1;</code></p>
</li>
<li><p>In each terminal window press <code>Ctrl-C</code>to terminate.</p></li>
</ol>

<h3>
<a id="pre-built-binaries-and-docker-compose-recipes" class="anchor" href="#pre-built-binaries-and-docker-compose-recipes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Pre-built binaries and Docker Compose recipes</h3>

<p>Pre-built binaries, a User Manual and Docker Compose files are available for download from <a href="https://bintray.com/crisp/codekvast/distributions/view#files">Codekvast at Bintray</a></p>

<ul>
<li><p>codekvast-daemon-x.x.x.zip contains the <em>Codekvast Collector</em> and the <em>Codekvast Daemon</em>.</p></li>
<li><p>codekvast-warehouse-x.x.x.zip contains <em>Codekvast Warehouse</em> as a regular Linux System-V service. Install MariaDB separately.</p></li>
<li><p>docker-compose-x.x.x.yml is a Docker Compose file for running Codekvast Warehouse and MariaDB as Docker images.</p></li>
<li><p>CodekvastUserManual-x.x.x.html is a complete User Manual for all three components. It contains installation and configuration guides.</p></li>
<li><p>RELEASE-NOTES-x.x.x.md contains release notes.</p></li>
</ul>

<h2>
<a id="development-guide" class="anchor" href="#development-guide" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Development Guide</h2>

<p>If you have read this far, you're probably eager to do some Codekvast development. Welcome!</p>

<h3>
<a id="technology-stack" class="anchor" href="#technology-stack" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Technology Stack</h3>

<p>The following stack is used when developing Codekvast:</p>

<ol>
<li>Github</li>
<li>Java 8 (the collector is built with Java 6)</li>
<li>AspectJ (in Load-Time Weaving mode)</li>
<li>Spring Boot</li>
<li>Lombok</li>
<li>H2 database (disk persistent, embedded in Codekvast Daemon)</li>
<li>MariaDB 10+ (Codekvast Warehouse)</li>
<li>Gradle </li>
<li>Docker + Docker Compose (optional mode of running Codekvast Warehouse)</li>
</ol>

<h3>
<a id="directory-structure" class="anchor" href="#directory-structure" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Directory structure</h3>

<p>The product itself lives under <code>product/</code>.</p>

<p>Sample projects to use when testing Codekvast lives under <code>sample/</code>.</p>

<p>Development tools live under <code>tools/</code>.</p>

<h3>
<a id="development-environment" class="anchor" href="#development-environment" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Development environment</h3>

<h4>
<a id="jdk" class="anchor" href="#jdk" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JDK</h4>

<p>Java 8 <strong>and</strong> Java 6 is required. OpenJDK is recommended.</p>

<h4>
<a id="database" class="anchor" href="#database" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Database</h4>

<p>MariaDB v10.0 or later is required for Codekvast Warehouse.</p>

<p>Use the following command to install MariaDB (Ubuntu, Debian):</p>

<pre><code>sudo apt-get install mariadb-server
</code></pre>

<p>Then the following commands must be executed once:</p>

<pre><code>$ sudo mysql -e "create database codekvast_warehouse; grant all on codekvast_warehouse.* to 'codekvast'@'localhost' identified by 'codekvast';"
</code></pre>

<h4>
<a id="build-tool" class="anchor" href="#build-tool" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build tool</h4>

<p>Codekvast uses <strong>Gradle</strong> as build tool. It uses the Gradle Wrapper, <code>gradlew</code>, which is checked in at the root of the workspace.
There is the convenience script <code>tools/src/script/gradle</code> which simplifies invocation of gradlew. Install that script in your PATH
and use <code>gradle</code> instead of <code>path/to/gradlew</code></p>

<h4>
<a id="software-publishing" class="anchor" href="#software-publishing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Software publishing</h4>

<p>Codekvast binaries are published to Bintray. To be able to upload to Bintray you need the following lines in your <code>~/.gradle/gradle.properties</code>:</p>

<pre><code>bintrayUser=my-bintray-user
bintrayKey=my-bintray-key
</code></pre>

<p>You also need to be member of the Crisp organisation in Bintray.</p>

<h4>
<a id="ide" class="anchor" href="#ide" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>IDE</h4>

<p><strong>Intellij Ultimate Edition 15+</strong> is the recommended IDE with the following plugins:</p>

<ol>
<li>
<strong>Lombok Support</strong> (required)</li>
<li>Git (optional)</li>
<li>Github (optional)</li>
<li>AspectJ Support (optional)</li>
<li>AngularJS (optional)</li>
<li>Karma (optional)</li>
</ol>

<p>Do like this to open Codekvast in Intellij the first time:</p>

<ol>
<li>File -&gt; New -&gt; Project from Existing Sources...</li>
<li>Navigate to the project root</li>
<li>Import project from external model...</li>
<li>Select Gradle</li>
<li>Click Next</li>
<li>Accept the defaults (use the project's Gradle wrapper)</li>
<li>Click Finish</li>
</ol>

<p>After the import, some settings must be changed:</p>

<ol>
<li>File &gt; Settings...</li>
<li>Build, Execution, Deployment &gt; Compiler &gt; Annotation Processing</li>
<li>Check <strong>Enable annotation processing</strong>
</li>
<li>Click OK</li>
</ol>

<p>Then a couple of module settings must be changed:</p>

<ol>
<li><p>File &gt; Project Structure</p></li>
<li><p>Platform Settings &gt; SDKs
 You need <strong>both</strong> a <strong>1.6</strong> SDK <strong>and</strong> a <strong>1.8</strong> SDK.</p></li>
<li><p>Project Settings &gt; Project
Project SDK should be <strong>1.8</strong> and
Project language level should be <strong>8 - Lambdas, type annotations etc</strong></p></li>
<li><p>Project Settings &gt; Modules
The modules <strong>agent-lib</strong> and <strong>collector</strong> shall have
Language level <strong>6 - <a href="https://github.com/Override" class="user-mention">@Override</a> in interfaces</strong> and 
Module SDK: <strong>1.6</strong> (in the Dependencies tab)</p></li>
</ol>
        </section>

        <footer>
          Codekvast is maintained by <a href="https://github.com/crispab">crispab</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>

//--- Docker ---------------------------------------------------------------------------------------

distDocker {
    description "Builds the Docker image $codekvastWarehouseImageName:latest"
    group 'Distribution'
    baseImage 'java:8-jre'
    maintainer 'Olle Hallin "olle.hallin@crisp.se"'
    runCommand 'mkdir -p /var/log /tmp/codekvast'
    volume '/var/log'
    volume '/tmp/codekvast'
    tagVersion 'latest'

    def imageIdFile = file("$buildDir/tmp/dockerImageId")

    inputs.files fileTree('build/distributions')
    inputs.file imageIdFile
    outputs.file imageIdFile

    dependsOn ':product:warehouse:test'

    doFirst {
        def command = "docker pull $codekvastWarehouseImageName:latest"
        logger.lifecycle command
        command.execute().waitFor()
    }

    doLast {
        def imageId = "docker images -q $codekvastWarehouseImageName:latest".execute().text
        imageIdFile.text = "$imageId\n"
    }
}

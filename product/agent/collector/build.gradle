plugins {
    id "com.github.johnrengelman.shadow" version "1.2.1"
}
apply from: "$rootDir/gradle/java-6.gradle"
apply from: "$rootDir/gradle/sources-javadoc.gradle"
apply plugin: 'com.jfrog.bintray'

// This build script is prepared for publishing the shadow jar to bintray for linking to jcenter.
// It is however currently disabled, since bintray won't allow linking it to jcenter because the GitHub repo is not public.
// All bintray-related code is commented out with the marker JCENTER

description = "The javaagent part of Codekvast"
archivesBaseName = "codekvast-agent-collector"
version = project.parent.parent.version

configurations {
    aspectjweaver
}

dependencies {
    compile project(":product:agent:util"), { transitive = false }
    compile "org.aspectj:aspectjweaver:$aspectjVersion"

    aspectjweaver "org.aspectj:aspectjweaver:$aspectjVersion"

    // Absolutely NO other compile or runtime dependencies are allowed here!
    // All (transitive) compile and runtime dependencies will end up in the instrumented app's system
    // class path, which is unacceptable.

    testCompile junit
    testCompile mockito
}

shadowJar {
    baseName = "codekvast-collector"
    classifier = ''
    manifest {
        attributes(
                "Premain-Class": "se.crisp.codekvast.agent.collector.CodekvastCollector",
                "Implementation-Title": archivesBaseName,
                "Implementation-Version": codekvastDisplayVersion
        )
    }
    dependencies {
        exclude(dependency('org.aspectj:aspectjweaver'))
    }
}

task javaagents(type: Sync) {
    from configurations.aspectjweaver
    from tasks.shadowJar
    into "$buildDir/javaagents"
}

/*
--- JCENTER begin ---------------------
apply plugin: 'maven-publish'

publishing {
    publications {
        shadowJar(MavenPublication) {
            groupId 'se.crisp.codekvast'
            artifactId 'codekvast-collector'

            from components.shadow
            artifact sourcesJar { classifier "sources" }
            artifact javadocJar { classifier "javadoc" }
        }
    }
}

bintray {
    // These are supposed to be defined in $HOME/.gradle/gradle.properties
    user = project.hasProperty('bintrayUser') ? bintrayUser : "undefined"
    key = project.hasProperty('bintrayKey') ? bintrayKey : "undefined"

    publications = ['shadowJar']

    dryRun = false
    publish = true

    pkg {
        userOrg = bintrayUserOrg
        repo = 'maven-repo'
        name = 'codekvast-collector'
        desc = 'Just the javaagent part of Codekvast'
        vcsUrl = 'https://github.com/crispab/duck.git'
        licenses = ['MIT']

        publicDownloadNumbers = false
    }
}

bintrayUpload {
    doFirst {
        def gradleProperties = new File(System.properties['user.home'], ".gradle/gradle.properties")
        if (!project.hasProperty('bintrayUser')) {
            throw new IllegalArgumentException("You must define bintrayUser in $gradleProperties before trying to upload to Bintray")
        }
        if (!project.hasProperty('bintrayKey')) {
            throw new IllegalArgumentException("You must define bintrayKey in $gradleProperties before trying to upload to Bintray")
        }
    }
}
--- JCENTER end ---------------------
 */

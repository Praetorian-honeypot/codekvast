<div class="container">
    <h2>Status</h2>
    <div class="d-flex flex-row align-items-start justify-content-between">

        <div *ngIf="state.data">
            <h4>Plan {{ state.data.pricePlan }} Limits</h4>
            <table class="table table-striped table-bordered">
                <tr>
                    <td class="w-50">Number of {{ getAgentsLabel() }} (max={{ state.data.maxNumberOfAgents }}):</td>
                    <td class="w-50">
                        {{ agentsProgressValue() }}<br>
                        <ngb-progressbar [showValue]="true"
                                         [type]="progressBarType2(state.data.numLiveAgents, state.data.maxNumberOfAgents)"
                                         [value]="toPercent(state.data.numLiveAgents, state.data.maxNumberOfAgents)"></ngb-progressbar>
                    </td>
                </tr>
                <tr>
                    <td>Number of methods (max={{ state.data.maxNumberOfMethods }}):</td>
                    <td>
                        {{state.data.numMethods}}<br>
                        <ngb-progressbar [showValue]="true" [type]="progressBarType2(state.data.numMethods, state.data.maxNumberOfMethods)"
                                         [value]="toPercent(state.data.numMethods, state.data.maxNumberOfMethods)">

                        </ngb-progressbar>
                    </td>
                </tr>
                <tr>
                    <td>Collected since:</td>
                    <td>{{ state.data.collectedSinceMillis | ckAge:settings.dateFormat }}</td>
                </tr>
                <tr *ngIf="state.data.trialPeriodEndsAtMillis">
                    <td>Trial period ends:</td>
                    <td>
                        {{ state.data.trialPeriodEndsAtMillis | ckAge:settings.dateFormat }}<br>
                        <ngb-progressbar [showValue]="false"
                                         [type]="progressBarType(state.data.trialPeriodPercent)"
                                         [value]="state.data.trialPeriodPercent">
                            {{ trialPeriodProgressText(state.data.trialPeriodPercent) }}
                        </ngb-progressbar>
                    </td>
                </tr>
                <tr>
                    <td>Collection resolution:</td>
                    <td>{{ collectionResolution() }}</td>
                </tr>
            </table>
        </div>
        <div class="d-flex flex-column">
            <ck-settings-editor></ck-settings-editor>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Auto-refresh every</span>
                </div>
                <input class="form-control"
                       id="refreshInterval"
                       type="number"
                       required
                       min="10"
                       max="3600"
                       [(ngModel)]="state.refreshIntervalSeconds"
                       (change)="state.updateRefreshTimer()"/>
                <div class="input-group-append">
                    <span class="input-group-text">s</span>
                    <span class="input-group-btn">
                        <button class="btn" (click)="state.toggleAutoRefresh()" title="{{state.autoRefreshButtonText()}}">
                            <i [ngClass]="state.autoRefreshButtonClasses()" aria-hidden="true"></i>
                        </button>
                    </span>
                </div>
            </div>
            <div *ngIf="state.data">
                <small class="ml-2 col-form-label form-text text-muted">{{ state.data.timestamp | ckAge:settings.dateFormat }} Refreshed
                    status in {{ state.data.queryTimeMillis }} ms
                </small>
            </div>

            <div *ngIf="state.errorMessage">
                <small class="ml-2 col-form-label form-text text-muted" title="{{ state.errorMessage }}">{{ state.communicationFailure() }}
                </small>
            </div>
        </div>
    </div>

    <div *ngIf="state.data">
        <h4 class="text-capitalize">{{ getAgentsLabel() }}</h4>
        <div class="form-inline" [class.invisible]="state.numTerminatedAgents() === 0">
            <input id="showTerminatedAgents" type="checkbox" [(ngModel)]="state.showTerminatedAgents">
            <label class="ml-1" for="showTerminatedAgents">Show {{ state.numTerminatedAgents() }} terminated {{ getAgentsLabel() }}</label>
            <div class="input-group col-auto">
                <div class="input-group-prepend">
                    <span class="input-group-text">Select terminated agents older than</span>
                </div>
                <input class="form-control"
                       id="terminatedDays"
                       type="number"
                       required
                       min="0"
                       max="3650"
                       [(ngModel)]="state.selectTerminatedAgentsOlderThanDays"/>
                <div class="input-group-append">
                    <span class="input-group-text">days</span>
                    <span class="input-group-btn">
                        <button class="btn" (click)="state.selectOldTerminatedAgents()">
                            Select
                        </button>
                    </span>
                </div>
            </div>
            <button class="ml-5 btn btn-outline-secondary btn-sm" [disabled]="state.numSelectedTerminatedAgents() === 0"
                    (click)="state.deleteSelectedAgents()">Delete {{ state.numSelectedTerminatedAgents() }} selected terminated agents
            </button>
        </div>
        <table class="table table-striped table-bordered">
            <tr>
                <th>Application</th>
                <th>Environment</th>
                <th>Host</th>
                <th>Started at</th>
                <th>Data received at</th>
                <th>Next expected at</th>
                <th>Comments</th>
                <th><input type="checkbox" [(ngModel)]="state.selectAllTerminatedAgents" (change)="state.selectOrUnselectAllAgents()"/></th>
            </tr>
            <tr *ngFor="let agent of state.getFilteredAgents()">
                <td ngbPopover="{{ agent.agentVersion }}"
                    popoverTitle="Agent Version"
                    triggers="mouseenter:mouseleave"
                    placement="top"
                    container="body">
                    {{ agent.appName }} {{ agent.appVersion}}
                </td>
                <td>{{ agent.environment }}</td>
                <td>{{ agent.hostname }}</td>
                <td>{{ agent.startedAtMillis | ckAge:settings.dateFormat }}</td>
                <td>{{ agent.publishedAtMillis | ckAge:settings.dateFormat }}</td>
                <td>
                    <span [ngClass]="agentUploadExpectedAtClasses(agent)">{{ agent.nextPublicationExpectedAtMillis | ckAge:settings.dateFormat }}</span>
                </td>
                <td>{{ getComments(agent) }} <i [ngClass]="commentClasses(agent)"></i></td>
                <td><input [disabled]="agent.deletionState" type="checkbox" [(ngModel)]="agent.selected"></td>
            </tr>
        </table>
    </div>
</div>

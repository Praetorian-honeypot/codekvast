---
- name: Download codekvast-daemon tarball from Bintray
  get_url: url={{download_url_prefix}}{{tarball}} dest=/root/{{tarball}}

- name: Unpack codekvast-daemon tarball into /opt
  unarchive:
  args:
    src: /root/{{tarball}}
    dest: /opt
    creates: "{{codekvast_config}}"
    owner: "{{run_codekvast_daemon_as}}"
    copy: no

- name: Configure the Codekvast Daemon
  replace: dest={{codekvast_config}} regexp='.*codekvast\.environment.*' replace='codekvast.environment = {{codekvast_environment}}'
  replace: dest={{codekvast_config}} regexp='.*codekvast\.uploadToHost.*' replace='codekvast.uploadToHost = {{codekvast_warehouse}}'
  replace: dest={{codekvast_config}} regexp='.*codekvast\.verifyUploadToHostKey.*' replace='codekvast.verifyUploadToHostKey = {{verify_codekvast_warehouse_host_key}}'

- name: Define the Codekvast Daemon service
  file: src=/opt/codekvast-daemon-{{codekvast_version}}/codekvast-daemon.jar dest=/etc/init.d/{{service_name}} state=link force=yes

- name: Restart the Codekvast Daemon service
  service: name={{service_name}} state=restarted

- name: Remove the obsolete Codekvast Agent service
  file: path=/etc/init.d/codekvast-agent state=absent
  file: path=/var/log/codekvast state=absent
  file: path='/opt/codekvast-agent-*' state=absent
